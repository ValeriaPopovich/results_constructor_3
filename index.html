<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—è–º ‚Äî Pinterest style (PNG)</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" />
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --ink:#243037; --muted:#6b7280; --border:#e5e7eb; --bg:#f7fafc; --card:#fff;
    --brand:#ff6a3d; --brand2:#ff9f1a; --ring:rgba(255,106,61,.28);
    --radius:18px; --shadow:0 10px 30px rgba(17,24,39,.08);
  }
  *{box-sizing:border-box}
  html{-webkit-text-size-adjust:100%; scroll-behavior:smooth;}
  @media (prefers-reduced-motion: reduce){ html{scroll-behavior:auto;} }

  body{margin:0;background:var(--bg);color:var(--ink);
       font:16px/1.5 'Manrope',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;}
  .wrap{max-width:960px;margin:24px auto;padding:0 14px 80px}

  /* HERO */
  .hero{display:flex;justify-content:space-between;align-items:center;gap:16px;
    padding:20px;border-radius:24px;background:#ffc6d1;
    box-shadow:var(--shadow);margin-bottom:20px}
  .hero-title{margin:0;font-size:1.9rem;font-weight:800}
  .hero-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .author{font-weight:700;background:#fff;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .author a{color:inherit;text-decoration:none}
  .sub{border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px;border-radius:12px;
       font-weight:800;cursor:pointer;box-shadow:0 6px 14px rgba(255,106,61,.25);transition:.2s}
  .sub:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(255,106,61,.35)}

  /* Cards & inputs */
  .card{
    background:linear-gradient(#fff,#fff) padding-box,
               radial-gradient(120% 120% at 0% 0%, #ffe9e0, #e8f9f3) border-box;
    border:1px solid rgba(255,255,255,.7);
    border-radius:var(--radius);
    padding:16px; box-shadow:var(--shadow); transition:.2s;
  }
  .card:hover{box-shadow:0 14px 34px rgba(17,24,39,.12)}
  h2{margin:0 0 12px;font-size:1rem;text-transform:uppercase;color:var(--muted);letter-spacing:.02em}
  .grid{display:grid;gap:16px}
  .grid-2{grid-template-columns:1fr 1fr}
  .row{display:grid;grid-template-columns:minmax(160px,220px) 1fr;gap:12px;align-items:center}

  /* –í–ê–ñ–ù–û: –Ω–µ –ª–æ–º–∞–µ–º checkbox/radio */
  input:not([type="checkbox"]):not([type="radio"]), select{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff;
    transition:.2s;min-width:0;font-size:16px
  }
  input:not([type="checkbox"]):not([type="radio"]):focus, select:focus{
    outline:none;border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)
  }

  .btn{
    border:0;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;
    padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;
    box-shadow:0 6px 14px rgba(255,106,61,.25);transition:.2s
  }
  .btn:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(255,106,61,.35)}
  .btn.add{background:#fff;color:var(--brand);border:2px dashed rgba(255,106,61,.6)}
  .btn.add:hover{background:rgba(255,154,94,.16)}
  .btn.alt{
    background:linear-gradient(135deg,#22c55e,#16a34a);
    box-shadow:0 6px 14px rgba(34,197,94,.25);
  }
  .btn.alt:hover{box-shadow:0 10px 22px rgba(34,197,94,.35)}

  .list{display:grid;gap:10px;margin-top:10px}
  .item{
    display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
    background:#fffaf7;padding:10px;border-radius:12px;border:1px solid #ffe0d1
  }
  .item .cols{display:grid;grid-template-columns:1fr 180px;gap:10px;align-items:center}

  .badge{
    display:inline-flex;align-items:center;justify-content:center;
    padding:8px 12px;border-radius:999px;min-width:120px;font-weight:800;
    background:#fff0ec;color:#7c2d12;line-height:1.2;text-align:center
  }
  .hidden{display:none !important;}
  #notice{display:none;margin:10px 0;padding:10px 12px;border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;border-radius:12px;font-weight:700}

  .empty-note{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:2px dashed rgba(255,106,61,.35);background:rgba(255,154,94,.12);color:#7c2d12;font-weight:800}
  .empty-note::before{content:"‚ÑπÔ∏è"}

  /* Mini nav + toggles */
  .mini-nav{display:flex;gap:8px;flex-wrap:wrap}
  .mini-nav a{
    display:inline-flex;gap:8px;align-items:center;padding:6px 10px;
    background:#fff;border:1px solid var(--border);border-radius:999px;
    font-weight:700;color:inherit;text-decoration:none
  }
  .mini-nav a:hover{box-shadow:0 0 0 4px var(--ring)}
  .toggle-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .toggle-pill{
    display:inline-flex;gap:10px;align-items:center;padding:10px 14px;
    background:#fff;border:1px solid var(--border);border-radius:999px;font-weight:800;
  }
  .toggle-pill input[type="checkbox"]{transform:scale(1.2); width:auto}
  .helper-title{
    margin:0 0 8px;
    font-size:.9rem;
    font-weight:900;
    letter-spacing:.01em;
    color:#111827;
  }

  /* –û—Ü–µ–Ω–∫–∞: –ø–∏–ª—é–ª–∏ 1‚Äì5 */
  .grade-pills{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .grade-pill{
    display:inline-flex;align-items:center;justify-content:center;
    width:44px;height:36px;border-radius:12px;
    border:1px solid var(--border);
    background:#fff;font-weight:900;cursor:pointer;
    transition:.15s; user-select:none;
  }
  .grade-pill:hover{box-shadow:0 0 0 4px var(--ring)}
  .grade-pill.active{
    background:linear-gradient(135deg,var(--brand),var(--brand2));
    border-color:transparent;color:#fff;
  }

  /* Mocks */
  .section{border:1px dashed var(--border);border-radius:16px;padding:14px;background:#fff}
  .subsection-title{margin:0 0 8px;font-size:15px;color:#111827}
  .mock-item{
    display:grid; grid-template-columns:1fr auto; gap:10px; align-items:start;
    background:#fffaf7; padding:10px; border-radius:12px; border:1px solid #ffe0d1;
  }
  .mock-cols-1{display:grid;gap:10px}
  .mock-cols-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .mock-bottom{display:grid;gap:10px;margin-top:10px}

  /* Actions */
  .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:14px}
  .actions .btn{min-width:220px}
  .actions .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none; box-shadow:none}

  /* Report */
  #finalReport{display:none;margin-top:18px}
  .report{background:#fff;border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
  .report-header{padding:20px;background:#ffc6d1}
  .pill-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;background:#fff;border:1px solid var(--border);border-radius:999px;font-weight:700}
  .report-body{padding:20px;display:grid;gap:22px}
  .ul{margin:0;padding-left:22px}
  .ul li{margin:6px 0;padding:6px 10px;background:#fff7f3;border-radius:8px;box-shadow:inset 0 1px 2px rgba(0,0,0,.04)}

  /* –û—Ç—Å—Ç—É–ø –º–µ–∂–¥—É "–°—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á—ë—Ç–∞" –∏ "–®–∞–ø–∫–∞" */
  #structureCard{ margin-bottom:16px; }

  @media (max-width:900px){
    .grid-2{grid-template-columns:1fr}
    .row{grid-template-columns:1fr}
    .hero{flex-direction:column;align-items:flex-start}
    .hero-title{font-size:1.7rem}
  }
  @media (max-width:520px){
    body{font-size:15px}
    .wrap{padding:0 10px 60px}
    .btn,.sub{padding:10px 12px}

    .item{grid-template-columns:1fr}
    .item .cols{grid-template-columns:1fr}
    .mock-item{grid-template-columns:1fr}
    .mock-cols-2{grid-template-columns:1fr}
    .actions .btn{min-width:0; width:100%}
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="hero">
    <h1 class="hero-title">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤ —Ä–æ–¥–∏—Ç–µ–ª—è–º</h1>
    <div class="hero-right">
      <span class="author">–ê–≤—Ç–æ—Ä: <a href="https://t.me/may_tanya_04" target="_blank" rel="noopener">@may_tanya_04</a></span>
      <a class="sub" href="https://t.me/may_tanya_04" target="_blank" rel="noopener">–ù–∞–ø–∏—Å–∞—Ç—å</a>
    </div>
  </div>

  <div id="notice"></div>

  <div class="card" id="structureCard">
    <h2>–°—Ç—Ä–∞–Ω–∏—Ü—ã –æ—Ç—á—ë—Ç–∞</h2>

    <div class="helper-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
    <div class="mini-nav" style="margin-bottom:10px" id="topNav">
      <a href="#card-topics" data-nav="topics">–¢–µ–º—ã</a>
      <a href="#card-hws" data-nav="hws">–î–æ–º–∞—à–Ω–∏–µ</a>
      <a href="#card-tests" data-nav="tests">–°—Ä–µ–∑—ã</a>
      <a href="#card-mocks" data-nav="mocks">–ü—Ä–æ–±–Ω–∏–∫–∏</a>
    </div>

    <div class="helper-title">–£–∫–∞–∂–∏—Ç–µ, —á—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –æ—Ç—á–µ—Ç</div>
    <div class="toggle-row">
      <label class="toggle-pill"><input type="checkbox" checked data-toggle="topics"> –¢–µ–º—ã</label>
      <label class="toggle-pill"><input type="checkbox" checked data-toggle="hws"> –î–æ–º–∞—à–Ω–∏–µ</label>
      <label class="toggle-pill"><input type="checkbox" checked data-toggle="tests"> –°—Ä–µ–∑—ã</label>
      <label class="toggle-pill"><input type="checkbox" checked data-toggle="mocks"> –ü—Ä–æ–±–Ω–∏–∫–∏</label>
    </div>
  </div>

  <div class="grid">
    <div class="card" id="card-who">
      <h2>–®–∞–ø–∫–∞</h2>
      <div class="grid grid-2">
        <div class="row"><div>–ü–µ–¥–∞–≥–æ–≥</div><input id="teacher" placeholder="–ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"></div>
        <div class="row"><div>–ú–µ—Å—è—Ü</div><input id="period" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –°–µ–Ω—Ç—è–±—Ä—å 2025"></div>
        <div class="row"><div>–ò–º—è —É—á–µ–Ω–∏–∫–∞</div><input id="student" placeholder="–ò–º—è"></div>
        <div class="row"><div>–ö–æ–ª-–≤–æ –∑–∞–Ω—è—Ç–∏–π</div><input id="totalLessons" type="number" min="0" step="1" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 8"></div>
      </div>
    </div>

    <div class="card" id="card-topics" data-form="topics">
      <h2>–¢–µ–º—ã</h2>
      <div id="topics" class="list"></div>
      <button class="btn add" id="addTopic" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º—É</button>
    </div>

    <div class="card" id="card-hws" data-form="hws">
      <h2>–î–æ–º–∞—à–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</h2>
      <div class="row">
        <div>–ë—ã–ª–∏ –¥–æ–º–∞—à–Ω–∏–µ?</div>
        <div class="radio-group">
          <label><input type="radio" name="hwsYN" value="yes" checked> –î–∞</label>
          <label><input type="radio" name="hwsYN" value="no"> –ù–µ—Ç</label>
        </div>
      </div>
      <div id="homeworksBlock">
        <div id="homeworks" class="list"></div>
        <button class="btn add" id="addHw" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞—à–∫—É</button>
      </div>
      <div id="hwsNone" class="empty-note" style="display:none; margin-top:10px">–î–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ –±—ã–ª–æ.</div>
    </div>

    <div class="card" id="card-tests" data-form="tests">
      <h2>–°—Ä–µ–∑—ã –∑–Ω–∞–Ω–∏–π</h2>
      <div class="row">
        <div>–ë—ã–ª–∏ —Å—Ä–µ–∑—ã?</div>
        <div class="radio-group">
          <label><input type="radio" name="testsYN" value="yes" checked> –î–∞</label>
          <label><input type="radio" name="testsYN" value="no"> –ù–µ—Ç</label>
        </div>
      </div>
      <div id="testsBlock">
        <div id="tests" class="list"></div>
        <button class="btn add" id="addTest" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ä–µ–∑</button>
      </div>
      <div id="testsNone" class="empty-note" style="display:none; margin-top:10px">–°—Ä–µ–∑–æ–≤ –Ω–µ –±—ã–ª–æ.</div>
    </div>

    <div class="card" id="card-mocks" data-form="mocks">
      <h2>–ü—Ä–æ–±–Ω–∏–∫–∏</h2>

      <div class="section" style="margin-top:8px">
        <h3 class="subsection-title">–ü—Ä–æ–±–Ω–∏–∫–∏ –ø–æ –±–ª–æ–∫—É –∞–ª–≥–µ–±—Ä–∞</h3>
        <div id="mocksAlgebra" class="list"></div>
        <button class="btn add" id="addMockAlgebra" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–±–Ω–∏–∫ (–∞–ª–≥–µ–±—Ä–∞)</button>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 class="subsection-title">–ü—Ä–æ–±–Ω–∏–∫–∏ –ø–æ –±–ª–æ–∫—É –≥–µ–æ–º–µ—Ç—Ä–∏—è</h3>
        <div id="mocksGeometry" class="list"></div>
        <button class="btn add" id="addMockGeometry" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–±–Ω–∏–∫ (–≥–µ–æ–º–µ—Ç—Ä–∏—è)</button>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 class="subsection-title">–û–±—â–∏–µ –ø—Ä–æ–±–Ω–∏–∫–∏</h3>
        <div id="mocksGeneral" class="list"></div>
        <button class="btn add" id="addMockGeneral" type="button" style="margin-top:8px">+ –î–æ–±–∞–≤–∏—Ç—å –æ–±—â–∏–π –ø—Ä–æ–±–Ω–∏–∫</button>
      </div>
    </div>
  </div>

  <div class="actions">
    <button class="btn" id="generate" type="button">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
    <button class="btn alt" id="downloadWholeTop" type="button" disabled>–°–∫–∞—á–∞—Ç—å PNG</button>
  </div>

  <div id="finalReport">
    <div class="report" id="reportCard">
      <div class="report-header" id="reportHeader">
        <h2 style="margin:0">–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç</h2>
        <div class="pill-row">
          <span class="pill">–ü–µ–¥–∞–≥–æ–≥: <span id="fr-teacher"></span></span>
          <span class="pill">–£—á–µ–Ω–∏–∫: <span id="fr-student"></span></span>
          <span class="pill">–ú–µ—Å—è—Ü: <span id="fr-period"></span></span>
          <span class="pill">–ö–æ–ª-–≤–æ –∑–∞–Ω—è—Ç–∏–π: <span id="fr-lessons"></span></span>
        </div>
      </div>

      <div class="report-body">
        <div class="section" data-block="topics"><h3>–¢–µ–º—ã</h3><div id="fr-topics">‚Äî</div></div>

        <div class="section" data-block="hws">
          <h3>–î–æ–º–∞—à–Ω–∏–µ —Ä–∞–±–æ—Ç—ã</h3>
          <div id="fr-homeworks">‚Äî</div>
          <div id="fr-homeworks-summary" style="margin-top:8px;font-weight:800"></div>
        </div>

        <div class="section" data-block="tests">
          <h3>–°—Ä–µ–∑—ã –∑–Ω–∞–Ω–∏–π</h3>
          <div id="fr-tests">‚Äî</div>
          <div id="fr-tests-summary" style="margin-top:8px;font-weight:800"></div>
        </div>

        <div class="section" data-block="mocks">
          <h3>–ü—Ä–æ–±–Ω–∏–∫–∏</h3>
          <div id="fr-mocks">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $  = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const int = n => Math.round(Number(n)||0);
  const face = v => (v=+v)<=1?'üòû':v==2?'üôÅ':v==3?'üòê':v==4?'üôÇ':'üòÑ';

  function showError(msg){ const n=$('#notice'); n.textContent=msg; n.style.display='block'; window.scrollTo({top:0,behavior:'smooth'}); }
  function clearError(){ const n=$('#notice'); n.textContent=''; n.style.display='none'; }

  // 2) –ú–µ—Å—è—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∏–π (—Ç–µ–∫—Å—Ç–æ–º), –Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π
  function getCurrentMonthText(){
    const months = [
      '–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å',
      '–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'
    ];
    const d = new Date();
    return `${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  // 4) –ü–µ–¥–∞–≥–æ–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  function applyDefaultHeaderValues(){
    const teacher = $('#teacher');
    const period  = $('#period');
    if(teacher && !teacher.value.trim()) teacher.value = '–í–æ—Ä–æ–Ω–∏–Ω–∞ –¢–∞—Ç—å—è–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞';
    if(period  && !period.value.trim())  period.value  = getCurrentMonthText();
  }

  document.addEventListener('DOMContentLoaded', applyDefaultHeaderValues);
  if (document.readyState !== 'loading') applyDefaultHeaderValues();

  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href^="#"]');
    if(!a) return;
    const id = a.getAttribute('href');
    const el = id ? document.querySelector(id) : null;
    if(!el) return;
    e.preventDefault();
    el.scrollIntoView({behavior:'smooth', block:'start'});
    history.replaceState(null,'',id);
  });

  function statusHTML(){
    return `<select class="statusSel">
      <option value="no" selected>–Ω–µ —Å–¥–∞–Ω–æ</option>
      <option value="redo">–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å</option>
      <option value="yes">—Å–¥–∞–Ω–æ</option>
    </select>`;
  }

  function gradePillsHTML(){
    return `<div class="grade-pills gradeWrap hidden" role="group" aria-label="–û—Ü–µ–Ω–∫–∞ 1-5">
      ${[1,2,3,4,5].map(n=>`<button type="button" class="grade-pill" data-grade="${n}">${n}</button>`).join('')}
      <input type="hidden" class="gradeVal" value="3">
    </div>`;
  }

  function statusLabel(status){
    if(status==='yes') return '—Å–¥–∞–Ω–æ';
    if(status==='redo') return '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–µ–ª–∞—Ç—å';
    return '–Ω–µ —Å–¥–∞–Ω–æ';
  }

  function bindStatus(item){
    const sel=item.querySelector('.statusSel');
    const badge=item.querySelector('.badge');
    const wrap=item.querySelector('.gradeWrap');
    const hiddenVal=item.querySelector('.gradeVal');
    const pills=[...item.querySelectorAll('.grade-pill')];

    const setActive = (v)=>{
      hiddenVal.value=String(v);
      pills.forEach(b=>b.classList.toggle('active', b.dataset.grade===String(v)));
      badge.textContent = `–æ—Ü–µ–Ω–∫–∞: ${v} ${face(v)}`;
    };

    pills.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(sel.value!=='yes') return;
        setActive(btn.dataset.grade);
      });
    });

    const update = ()=>{
      const isYes = sel.value === 'yes';
      wrap.classList.toggle('hidden', !isYes);

      if(isYes){
        badge.classList.remove('hidden');
        setActive(hiddenVal.value || 3);
      }else{
        badge.classList.add('hidden');
        badge.textContent = '';
      }
    };

    sel.addEventListener('change', update);
    update();
  }

  function gradeItemHTML(kind){
    const title = kind==='test'?'–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ä–µ–∑–∞':'–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è';
    return `<div class="item">
      <div class="cols">
        <input class="title" placeholder="${title}">
        ${statusHTML()}
      </div>
      ${gradePillsHTML()}
      <span class="badge hidden"></span>
      <button class="btn add removeBtn" type="button">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  }

  function addTopic(){
    const d=document.createElement('div');
    d.className='item';
    d.innerHTML='<input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã"><button class="btn add removeBtn" type="button">–£–¥–∞–ª–∏—Ç—å</button>';
    $('#topics').appendChild(d);
  }
  function addTest(){
    const d=document.createElement('div'); d.innerHTML=gradeItemHTML('test');
    const el=d.firstElementChild;
    $('#tests').appendChild(el);
    bindStatus(el);
  }
  function addHw(){
    const d=document.createElement('div'); d.innerHTML=gradeItemHTML('hw');
    const el=d.firstElementChild;
    $('#homeworks').appendChild(el);
    bindStatus(el);
  }

  function mockHTML(){
    return `<div class="mock-item">
      <div class="mock-cols-1">
        <input class="mockNo" placeholder="–ù–æ–º–µ—Ä –ª–∏–±–æ –Ω–∞–∑–≤–∞–Ω–∏–µ">
        <div class="mock-cols-2">
          <input class="mockTotal" type="number" min="1" step="1" inputmode="numeric" pattern="[0-9]*" placeholder="–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π">
          <input class="mockCorrect" type="number" min="0" step="1" inputmode="numeric" pattern="[0-9]*" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö">
        </div>
        <div class="mock-bottom">
          <span class="badge">‚Äî</span>
        </div>
      </div>
      <button class="btn add removeBtn" type="button">–£–¥–∞–ª–∏—Ç—å</button>
    </div>`;
  }

  function addMockTo(listId){
    const d=document.createElement('div'); d.innerHTML=mockHTML();
    const el=d.firstElementChild;
    document.getElementById(listId).appendChild(el);

    const total=el.querySelector('.mockTotal');
    const corr =el.querySelector('.mockCorrect');
    const badge=el.querySelector('.badge');

    const upd=()=>{
      const t=int(total.value), c=int(corr.value);
      if(t>0 && c>=0 && c<=t){
        const p=Math.round(c*100/t);
        badge.textContent = `—Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${p}%`;
        el.dataset.invalid = 'false';
      }else if(t>0 && c>t){
        badge.textContent='–Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–æ–ª—å—à–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π';
        el.dataset.invalid = 'true';
      }else{
        badge.textContent='‚Äî';
        el.dataset.invalid = 'false';
      }
    };
    total.addEventListener('input',upd,{passive:true});
    corr.addEventListener('input',upd,{passive:true});
    upd();
  }

  function bindStaticButtons(){
    const safeBind = (id, fn) => {
      const el=document.getElementById(id);
      if(el && !el._bound){ el.addEventListener('click', fn); el._bound=true; }
    };
    safeBind('addTopic', addTopic);
    safeBind('addTest', addTest);
    safeBind('addHw', addHw);
    safeBind('addMockAlgebra', ()=>addMockTo('mocksAlgebra'));
    safeBind('addMockGeometry', ()=>addMockTo('mocksGeometry'));
    safeBind('addMockGeneral', ()=>addMockTo('mocksGeneral'));
  }
  document.addEventListener('DOMContentLoaded', bindStaticButtons);
  if (document.readyState !== 'loading') bindStaticButtons();
  requestAnimationFrame(bindStaticButtons);

  document.addEventListener('click', e=>{
    if (e.target.classList?.contains('removeBtn')) e.target.closest('.item, .mock-item')?.remove();
  });

  $$( 'input[name="testsYN"]' ).forEach(r=>r.addEventListener('change',()=>{
    const yes=$('input[name="testsYN"]:checked').value==='yes';
    $('#testsBlock').style.display = yes?'':'none';
    $('#testsNone').style.display  = yes?'none':'';
  }));
  $$('input[name="hwsYN"]').forEach(r=>r.addEventListener('change',()=>{
    const yes=$('input[name="hwsYN"]:checked').value==='yes';
    $('#homeworksBlock').style.display = yes?'':'none';
    $('#hwsNone').style.display       = yes?'none':'';
  }));

  function getEnabledBlocks(){
    return new Set($$('[data-toggle]').filter(x=>x.checked).map(x=>x.dataset.toggle));
  }

  // 1) –ó–∞–ø—Ä–µ—Ç —Å–Ω—è—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≥–∞–ª–æ—á–∫—É
  function enforceAtLeastOneToggle(changedCb){
    const all = $$('[data-toggle]');
    const checked = all.filter(x=>x.checked);
    if(checked.length === 0){
      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
      changedCb.checked = true;
      // –±–µ–∑ –º–æ—Ä–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ —Ñ–∞–∫—Ç
      showError('–í –æ—Ç—á—ë—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫ üôÇ');
      return false;
    }
    return true;
  }

  function applyBlockVisibility(){
    const enabled = getEnabledBlocks();
    $$('[data-form]').forEach(card=>{
      card.style.display = enabled.has(card.dataset.form) ? '' : 'none';
    });
    $$('[data-nav]').forEach(a=>{
      a.style.display = enabled.has(a.dataset.nav) ? '' : 'none';
    });
    $$('[data-block]').forEach(sec=>{
      sec.style.display = enabled.has(sec.dataset.block) ? '' : 'none';
    });
  }

  $$('[data-toggle]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      clearError();
      if(!enforceAtLeastOneToggle(cb)) return;
      applyBlockVisibility();
    });
  });
  applyBlockVisibility();

  async function exportWholeReportPng({scale=2}={}){
    const report = document.getElementById('reportCard');
    const studentSafe = ($('#student').value.trim() || '–£—á–µ–Ω–∏–∫').replace(/\s+/g,'_');
    const periodSafe  = ($('#period').value.trim()  || '–ú–µ—Å—è—Ü').replace(/\s+/g,'_');

    const canvas = await html2canvas(report, {
      scale,
      backgroundColor: null,
      windowWidth: document.documentElement.offsetWidth
    });
    const url = canvas.toDataURL('image/png');

    const a=document.createElement('a');
    a.href=url;
    a.download=`–û—Ç—á—ë—Ç_${studentSafe}_${periodSafe}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  const downloadBtn = document.getElementById('downloadWholeTop');
  downloadBtn.addEventListener('click', ()=>{
    exportWholeReportPng({scale:2}).catch(()=>showError('PNG –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.'));
  });

  $('#generate').addEventListener('click', async ()=>{
    clearError();
    const enabled = getEnabledBlocks();

    // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫–∞–∫-—Ç–æ –æ–±–æ—à–ª–∏ –∑–∞–ø—Ä–µ—Ç
    if(enabled.size === 0){
      return showError('–í –æ—Ç—á—ë—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–ª–æ–∫ üôÇ');
    }

    const invalidMock = $('#card-mocks .mock-item[data-invalid="true"]');
    if (enabled.has('mocks') && invalidMock){
      return showError('–í –ø—Ä–æ–±–Ω–∏–∫–∞—Ö: –Ω–µ–ª—å–∑—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±–æ–ª—å—à–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è.');
    }

    const teacher=$('#teacher').value.trim();
    const period=$('#period').value.trim();
    const student=$('#student').value.trim();
    const totalLessons=int($('#totalLessons').value);

    if(!teacher) return showError('–£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø–µ–¥–∞–≥–æ–≥–∞');
    if(!period)  return showError('–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü');
    if(!student) return showError('–£–∫–∞–∂–∏—Ç–µ –∏–º—è —É—á–µ–Ω–∏–∫–∞');
    if(totalLessons<=0) return showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ¬´–ö–æ–ª-–≤–æ –∑–∞–Ω—è—Ç–∏–π¬ª');

    let testsEnabled = enabled.has('tests') && $('input[name="testsYN"]:checked')?.value === 'yes';
    let tests=[];
    if(enabled.has('tests') && testsEnabled){
      $$('#tests .item').forEach(row=>{
        const name=row.querySelector('.title').value.trim()||'–°—Ä–µ–∑';
        const status=row.querySelector('.statusSel')?.value||'no';
        const val = (status==='yes') ? +row.querySelector('.gradeVal')?.value : null;
        tests.push({name,status,val});
      });
      if(!tests.length) return showError('–í—ã–±—Ä–∞–Ω–æ ¬´–î–∞¬ª –¥–ª—è —Å—Ä–µ–∑–æ–≤, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ');
    }

    let hwsEnabled = enabled.has('hws') && $('input[name="hwsYN"]:checked')?.value === 'yes';
    let hws=[];
    if(enabled.has('hws') && hwsEnabled){
      $$('#homeworks .item').forEach(row=>{
        const name=row.querySelector('.title').value.trim()||'–î–æ–º–∞—à–∫–∞';
        const status=row.querySelector('.statusSel')?.value||'no';
        const val = (status==='yes') ? +row.querySelector('.gradeVal')?.value : null;
        hws.push({name,status,val});
      });
      if(!hws.length) return showError('–í—ã–±—Ä–∞–Ω–æ ¬´–î–∞¬ª –¥–ª—è –¥–æ–º–∞—à–Ω–∏—Ö, –Ω–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π');
    }

    const readMocksFrom = (listId) => {
      const arr=[];
      $$('#'+listId+' .mock-item').forEach(row=>{
        if(row.dataset.invalid === 'true') return;
        const no   = row.querySelector('.mockNo')?.value.trim() || '';
        const total= int(row.querySelector('.mockTotal')?.value);
        const corr = int(row.querySelector('.mockCorrect')?.value);
        if(total>0 && corr>=0 && corr<=total){
          const pct = Math.round(corr*100/total);
          arr.push({no,total,corr,pct});
        }
      });
      return arr;
    };
    const mocksAlgebra  = enabled.has('mocks') ? readMocksFrom('mocksAlgebra') : [];
    const mocksGeometry = enabled.has('mocks') ? readMocksFrom('mocksGeometry') : [];
    const mocksGeneral  = enabled.has('mocks') ? readMocksFrom('mocksGeneral') : [];

    $('#fr-teacher').textContent=teacher;
    $('#fr-period').textContent=period;
    $('#fr-student').textContent=student;
    $('#fr-lessons').textContent=String(totalLessons);

    if(enabled.has('topics')){
      const topics=$$('#topics .item input').map(i=>i.value.trim()).filter(Boolean);
      $('#fr-topics').innerHTML = topics.length ? `<ul class="ul">${topics.map(t=>`<li>${t}</li>`).join('')}</ul>` : '‚Äî';
    }

    if(enabled.has('hws')){
      const hwsTotal = hwsEnabled ? hws.length : 0;
      const hwsDone  = hwsEnabled ? hws.filter(h=>h.status==='yes').length : 0;
      const hwsPct   = hwsTotal ? Math.round(hwsDone*100/hwsTotal) : 0;

      $('#fr-homeworks').innerHTML = (!hwsEnabled || !hwsTotal)
        ? '‚Äî'
        : `<ul class="ul">
            ${hws.map(h=>{
              const st = statusLabel(h.status);
              const grade = (h.status==='yes') ? ` ‚Äî <strong>–æ—Ü–µ–Ω–∫–∞ ${h.val}</strong> ${face(h.val)}` : '';
              return `<li>${h.name}: <strong>${st}</strong>${grade}</li>`;
            }).join('')}
          </ul>`;

      $('#fr-homeworks-summary').textContent =
        (!hwsEnabled || !hwsTotal) ? '' : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–æ–º–∞—à–Ω–∏—Ö —Ä–∞–±–æ—Ç: ${hwsDone} –∏–∑ ${hwsTotal} (${hwsPct}%)`;
    }

    if(enabled.has('tests')){
      const testsTotal = testsEnabled ? tests.length : 0;
      const testsDone  = testsEnabled ? tests.filter(t=>t.status==='yes').length : 0;
      const testsPct   = testsTotal ? Math.round(testsDone*100/testsTotal) : 0;

      $('#fr-tests').innerHTML = (!testsEnabled || !testsTotal)
        ? '‚Äî'
        : `<ul class="ul">
            ${tests.map(t=>{
              const st = statusLabel(t.status);
              const grade = (t.status==='yes') ? ` ‚Äî <strong>–æ—Ü–µ–Ω–∫–∞ ${t.val}</strong> ${face(t.val)}` : '';
              return `<li>${t.name}: <strong>${st}</strong>${grade}</li>`;
            }).join('')}
          </ul>`;

      $('#fr-tests-summary').textContent =
        (!testsEnabled || !testsTotal) ? '' : `–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å—Ä–µ–∑–æ–≤: ${testsDone} –∏–∑ ${testsTotal} (${testsPct}%)`;
    }

    if(enabled.has('mocks')){
      const renderGroup = (title, arr) => {
        if(!arr.length){
          return `<div style="margin-top:10px">
            <div style="font-weight:900;margin-bottom:6px">${title}</div>
            <div>‚Äî</div>
          </div>`;
        }
        return `<div style="margin-top:10px">
          <div style="font-weight:900;margin-bottom:6px">${title}</div>
          <ul class="ul">
            ${arr.map(m=>`
              <li>${m.no?m.no:'–ü—Ä–æ–±–Ω–∏–∫'} ‚Äî –≤—Å–µ–≥–æ: <strong>${m.total}</strong>, –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: <strong>${m.corr}</strong>, —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong>${m.pct}%</strong></li>
            `).join('')}
          </ul>
        </div>`;
      };

      $('#fr-mocks').innerHTML =
        (!mocksAlgebra.length && !mocksGeometry.length && !mocksGeneral.length)
          ? '‚Äî'
          : [
              renderGroup('–ü—Ä–æ–±–Ω–∏–∫–∏ –ø–æ –±–ª–æ–∫—É –∞–ª–≥–µ–±—Ä–∞', mocksAlgebra),
              renderGroup('–ü—Ä–æ–±–Ω–∏–∫–∏ –ø–æ –±–ª–æ–∫—É –≥–µ–æ–º–µ—Ç—Ä–∏—è', mocksGeometry),
              renderGroup('–û–±—â–∏–µ –ø—Ä–æ–±–Ω–∏–∫–∏', mocksGeneral),
            ].join('');
    }

    $('#finalReport').style.display='block';
    applyBlockVisibility();
    document.getElementById('reportCard').scrollIntoView({behavior:'smooth'});
    downloadBtn.disabled = false;
  });
</script>
</body>
</html>
